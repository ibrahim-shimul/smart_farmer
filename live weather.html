<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weather & Crop Advice Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(to bottom, #0b1d3a, #142850);
    color: #fff;
    display: flex;
    justify-content: center;
    flex-direction: column;
    min-height: 100vh;
    position: relative;
  }

  .main-header {
    text-align: center;
    font-size: 2rem;
    font-weight: bold;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-bottom: 2px solid rgba(255,255,255,0.2);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  /* Current location header similar to the image */
  .current-location-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    background: rgba(255, 255, 255, 0.08);
    border-bottom: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 20px;
  }
  
  .current-city {
    font-size: 1.4rem;
    font-weight: 600;
    color: #ffd54f;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  
  .current-date {
    font-size: 1.1rem;
    color: #ddd;
  }

  .container {
    width: 95%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    flex: 1;
  }

  .main-panel {
    flex: 2;
    display: flex;
    flex-direction: column;
    gap: 20px;
    min-width: 300px;
  }

  .side-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 20px;
    min-width: 300px;
  }

  .panel-section {
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .weather-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    margin-bottom: 10px;
  }

  .current-weather {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border-radius: 12px;
    background: rgba(255,255,255,0.08);
  }

  .current-weather img {
    width: 70px;
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.3));
  }

  .temp {
    font-size: 2.5rem;
    font-weight: bold;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  .desc {
    font-size: 1.1rem;
    color: #ddd;
    margin: 5px 0;
    text-transform: capitalize;
  }

  .details {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 15px;
  }

  .detail-card {
    flex: 1 1 120px;
    background: rgba(255,255,255,0.08);
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    font-size: 0.9rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .detail-card strong {
    display: block;
    margin-bottom: 5px;
    color: #4fc3f7;
  }

  .forecast {
    margin-top: 10px;
  }

  .forecast h3 {
    margin-bottom: 15px;
    font-size: 1.2rem;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding-bottom: 10px;
    color: #4fc3f7;
  }

  .forecast-cards {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 10px;
  }

  .forecast-card {
    background: rgba(255,255,255,0.08);
    padding: 12px;
    border-radius: 10px;
    min-width: 90px;
    text-align: center;
    font-size: 0.85rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s;
  }

  .forecast-card:hover {
    transform: translateY(-5px);
    background: rgba(255,255,255,0.12);
  }

  .forecast-card img {
    width: 40px;
    margin: 5px 0;
  }

  .chart-container {
    background: rgba(255,255,255,0.05);
    padding: 20px;
    border-radius: 12px;
    height: 350px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .chart-container h3 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 1.2rem;
    color: #4fc3f7;
  }

  #hourlyChart {
    height: 280px !important;
    width: 100% !important;
  }

  .crop-search {
    padding: 15px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .crop-search h3 {
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 1.2rem;
    color: #4fc3f7;
  }

  .crop-search input {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    background: rgba(255,255,255,0.1);
    color: white;
  }

  .crop-search input::placeholder {
    color: rgba(255,255,255,0.6);
  }

  .crop-search button.search-btn {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    background-color: #4fc3f7;
    color: #000;
    font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s;
  }

  .crop-search button.search-btn:hover {
    background-color: #29b6f6;
  }

  .crop-info {
    margin-top: 15px;
    font-size: 0.9rem;
    line-height: 1.5;
    background: rgba(255,255,255,0.08);
    padding: 15px;
    border-radius: 8px;
  }

  .back-btn {
    padding: 12px 20px;
    background: #ff5722;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: background-color 0.3s;
  }

  .back-btn:hover {
    background: #ff7043;
  }

  #map {
    height: 250px;
    width: 100%;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  .manual-weather {
    padding: 15px;
    border-radius: 12px;
  }

  .manual-weather h3 {
    margin-top: 0;
    margin-bottom: 12px;
    font-size: 1.2rem;
    color: #4fc3f7;
  }

  .manual-weather input {
    width: 65%;
    padding: 10px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    background: rgba(255,255,255,0.1);
    color: white;
    margin-right: 10px;
  }

  .manual-weather input::placeholder {
    color: rgba(255,255,255,0.6);
  }

  .manual-weather button {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    background-color: #4fc3f7;
    color: #000;
    font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s;
  }

  .manual-weather button:hover {
    background-color: #29b6f6;
  }

  .manual-info {
    margin-top: 15px;
    font-size: 0.9rem;
    background: rgba(255,255,255,0.08);
    padding: 15px;
    border-radius: 8px;
  }

  @media (max-width: 768px) {
    .container {
      flex-direction: column;
    }
    
    .main-panel, .side-panel {
      width: 100%;
    }
    
    .current-location-header {
      flex-direction: column;
      gap: 10px;
      text-align: center;
    }
    
    .current-weather {
      flex-direction: column;
      text-align: center;
    }
    
    .temp {
      font-size: 2rem;
    }
  }
</style>
</head>
<body>

  <!-- Main header -->
  <div class="main-header">🌱 Live Weather & Farming Guide</div>

  <!-- Current location header similar to the reference image -->
  <div class="current-location-header">
    <div class="current-city" id="current-city-header">Current Location</div>
    <div class="current-date" id="current-date-header">Fri Aug 22 2025</div>
  </div>

<div class="container">
  <div class="main-panel">
    <div class="panel-section">
      <div class="weather-header">
        <h2 id="city">Loading city...</h2>
        <p id="today-date"></p>
      </div>

      <div class="current-weather">
        <img id="icon" src="" alt="Weather Icon">
        <div>
          <p class="temp" id="temp"></p>
          <p class="desc" id="desc"></p>
        </div>
      </div>

      <div class="details">
        <div class="detail-card">
          <strong>Humidity</strong>
          <span id="humidity"></span>
        </div>
        <div class="detail-card">
          <strong>Wind</strong>
          <span id="wind"></span>
        </div>
        <div class="detail-card">
          <strong>Visibility</strong>
          <span id="visibility"></span>
        </div>
        <div class="detail-card">
          <strong>Pressure</strong>
          <span id="pressure"></span>
        </div>
      </div>
    </div>

    <div class="panel-section">
      <div class="forecast">
        <h3>Weekly Forecast</h3>
        <div class="forecast-cards" id="forecast-cards"></div>
      </div>
    </div>

    <div class="panel-section chart-container">
      <h3>Hourly Forecast</h3>
      <canvas id="hourlyChart"></canvas>
    </div>
  </div>

  <div class="side-panel">
    <div class="panel-section">
      <h3>Map</h3>
      <div id="map"></div>
    </div>

    <div class="panel-section manual-weather">
      <h3>Manual Weather Search</h3>
      <div>
        <input type="text" id="manualCity" placeholder="Enter city name">
        <button onclick="getManualWeather()">Search</button>
      </div>
      <div class="manual-info" id="manualInfo"></div>
    </div>

    <div class="panel-section crop-search">
      <h3>Search Crop Advice</h3>
      <input type="text" id="cropInput" placeholder="Enter fruit, vegetable, or crop">
      <button class="search-btn" onclick="searchCrop()">Search</button>
      <div class="crop-info" id="cropInfo"></div>
    </div>
  </div>
</div>

<!-- Back button -->
<button class="back-btn" onclick="history.back()">Back</button>

<script>
const apiKey = "52c1820ef053af31286ab4ce0cf9bdbf";
let hourlyChart;
let currentTemp = null;
let map, marker;

function initMap(lat = 23.8103, lon = 90.4125) {
  if(map) map.remove();
  map = L.map('map').setView([lat, lon], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);
  marker = L.marker([lat, lon]).addTo(map);
}

function updateMap(lat, lon){
  map.setView([lat, lon],10);
  if(marker) marker.setLatLng([lat, lon]);
  else marker = L.marker([lat, lon]).addTo(map);
}

async function getWeather(lat, lon){
  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`);
    const data = await res.json();

    // Set city + country
    document.getElementById("city").innerText = data.name + ", " + data.sys.country;

    // Set current city in the header
    document.getElementById("current-city-header").innerText = data.name + ", " + data.sys.country;

    // Set date in the header
    const today = new Date();
    document.getElementById("current-date-header").innerText = today.toDateString();
    document.getElementById("today-date").innerText = today.toDateString();
    
    const temp = Math.round(data.main.temp);
    currentTemp = temp;

    document.getElementById("temp").innerText = temp + "°C";
    document.getElementById("desc").innerText = data.weather[0].description;
    document.getElementById("icon").src = `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;

    document.getElementById("humidity").innerText = data.main.humidity + "%";
    document.getElementById("wind").innerText = data.wind.speed + " m/s";
    document.getElementById("visibility").innerText = (data.visibility/1000).toFixed(1) + " km";
    document.getElementById("pressure").innerText = data.main.pressure + " hPa";

    updateMap(lat, lon);
  } catch (error) {
    console.error("Error fetching weather data:", error);
    document.getElementById("city").innerText = "Error loading weather data";
  }
}

async function getForecast(lat, lon){
  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`);
    const data = await res.json();

    const forecastDiv = document.getElementById("forecast-cards");
    forecastDiv.innerHTML = "";

    const daily = {};
    data.list.forEach(item => {
      if(item.dt_txt.includes("12:00:00")) daily[new Date(item.dt_txt).toDateString()] = item;
    });

    Object.values(daily).forEach(day => {
      const date = new Date(day.dt_txt);
      forecastDiv.innerHTML += `<div class="forecast-card">
        <p>${date.toLocaleDateString("en-US",{weekday:"short"})}</p>
        <img src="https://openweathermap.org/img/wn/${day.weather[0].icon}@2x.png">
        <p>${Math.round(day.main.temp)}°C</p>
        <p>${day.weather[0].main}</p>
      </div>`;
    });

    const hours = data.list.slice(0,12).map(item => new Date(item.dt_txt).getHours() + ":00");
    const temps = data.list.slice(0,12).map(item => Math.round(item.main.temp));
    renderHourlyChart(hours, temps);
  } catch (error) {
    console.error("Error fetching forecast data:", error);
  }
}

function renderHourlyChart(hours, temps){
  const ctx = document.getElementById("hourlyChart").getContext("2d");
  if(hourlyChart) hourlyChart.destroy();
  hourlyChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: hours,
      datasets: [{
        label: "Temp (°C)",
        data: temps,
        borderColor: "#4fc3f7",
        backgroundColor: "rgba(79,195,247,0.3)",
        fill: true,
        tension: 0.4,
        pointBackgroundColor: "#fff",
        pointBorderColor: "#4fc3f7",
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: "rgba(0,0,0,0.7)",
          titleFont: {
            size: 14
          },
          bodyFont: {
            size: 13
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: "#fff",
            font: {
              size: 12
            }
          },
          grid: {
            color: "rgba(255,255,255,0.1)"
          }
        },
        y: {
          ticks: {
            color: "#fff",
            font: {
              size: 12
            }
          },
          grid: {
            color: "rgba(255,255,255,0.1)"
          }
        }
      }
    }
  });
}

async function searchCrop(){
  const query = document.getElementById("cropInput").value.trim();
  if(!query) return;
  let tempAdvice = "";
  if(currentTemp !== null){
    if(currentTemp < 10) tempAdvice = "⚠️ Temperature is low. Protect the crop from frost.";
    else if(currentTemp <= 25) tempAdvice = "✅ Temperature is optimal for growth.";
    else tempAdvice = "🌞 Temperature is high. Ensure irrigation and shade.";
  }

  try {
    const res = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
    const data = await res.json();
    const extract = data.extract || "No information found for this crop.";
    const dynamicAdvice = `<p><strong>Irrigation System:</strong> Ensure proper watering based on soil moisture.</p>
    <p><strong>Mulching:</strong> Apply organic mulch to retain soil moisture and control weeds.</p>
    <p><strong>Caution:</strong> Protect from extreme temperatures and monitor weather.</p>
    <p><strong>Pests:</strong> Regularly check for pests and apply organic or chemical controls if needed.</p>`;
    document.getElementById("cropInfo").innerHTML = `<p>${tempAdvice}</p><p>${extract}</p>${dynamicAdvice}`;
  } catch(err) {
    document.getElementById("cropInfo").innerHTML = "Error fetching crop info. Please try another crop name.";
  }
}

async function getManualWeather(){
  const city = document.getElementById("manualCity").value.trim();
  if(!city) return;

  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${apiKey}&units=metric`);
    const data = await res.json();
    if(data.cod !== 200){
      document.getElementById("manualInfo").innerHTML = "City not found. Please try another city name.";
      return;
    }

    document.getElementById("manualInfo").innerHTML = `
      <h4>${data.name}, ${data.sys.country}</h4>
      <p>Temp: ${Math.round(data.main.temp)}°C</p>
      <p>Humidity: ${data.main.humidity}%</p>
      <p>Wind: ${data.wind.speed} m/s</p>
      <p>Conditions: ${data.weather[0].description}</p>
    `;

    updateMap(data.coord.lat, data.coord.lon);
  } catch(err) {
    document.getElementById("manualInfo").innerHTML = "Error fetching weather data. Please try again.";
  }
}

function loadWeather(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos => {
      initMap(pos.coords.latitude, pos.coords.longitude);
      getWeather(pos.coords.latitude, pos.coords.longitude);
      getForecast(pos.coords.latitude, pos.coords.longitude);
    }, error => {
      console.error("Geolocation error:", error);
      document.getElementById("city").innerText = "Please allow location access";
      document.getElementById("current-city-header").innerText = "Current Location";
      initMap();
    });
  } else {
    document.getElementById("city").innerText = "Geolocation not supported";
    document.getElementById("current-city-header").innerText = "Current Location";
    initMap();
  }
}

loadWeather();
</script>
</body>
</html>